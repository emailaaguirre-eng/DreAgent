# =============================================================================
# HUMMINGBIRD-LEA - Docker Compose Production Override
# Powered by CoDre-X | B & D Servicing LLC
# =============================================================================
# Production-specific configuration
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # Hummingbird Application (Production)
  # ---------------------------------------------------------------------------
  hummingbird:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    restart: always
    environment:
      - APP_ENV=production
      - DEBUG=false
      - LOG_LEVEL=WARNING
    # Remove development volume mounts
    volumes:
      - hummingbird_data:/app/data
    # Use Gunicorn in production for better performance
    command: >
      gunicorn apps.hummingbird.main:app
      --workers ${WORKERS:-4}
      --worker-class uvicorn.workers.UvicornWorker
      --bind 0.0.0.0:8000
      --timeout ${WORKER_TIMEOUT:-120}
      --access-logfile /app/data/logs/access.log
      --error-logfile /app/data/logs/error.log
      --capture-output
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ---------------------------------------------------------------------------
  # Ollama (Production)
  # ---------------------------------------------------------------------------
  ollama:
    restart: always
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Nginx Reverse Proxy
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: hummingbird-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - hummingbird
    networks:
      - hummingbird-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

# =============================================================================
# Additional Volumes (Production)
# =============================================================================
volumes:
  nginx_logs:
    driver: local
